<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocuMind Architecture Diagram</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: sans-serif;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: #333;
        }

        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            text-align: center;
        }
    </style>
</head>

<body>
    <h1>DocuMind System Architecture</h1>
    <p>Rendered automatically via Mermaid.js</p>

    <div class="mermaid">
        %% [MermaidChart: b4177f8e-84ee-42f7-b390-7b2a921b7df3]
        graph TD
        %% --- STYLING DEFS ---
        classDef blue fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#0d47a1
        classDef green fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,color:#1b5e20
        classDef orange fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#e65100
        classDef purple fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#4a148c
        classDef red fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#c62828
        classDef yellow fill:#fffde7,stroke:#fbc02d,stroke-width:2px,color:#f57f17
        classDef grey fill:#fafafa,stroke:#9e9e9e,stroke-width:1px,stroke-dasharray: 5 5

        %% ==========================================
        %% 1. USER INTERFACE LAYER
        %% ==========================================
        subgraph UI [Frontend / User Layer]
        User([üë§ End User])
        Browser["üñ•Ô∏è Web Interface<br />(Flask Templates)"]
        API["üîå REST API<br />(Waitress WSGI)"]
        end

        %% ==========================================
        %% 2. INGESTION PIPELINE ( WRITE PATH )
        %% ==========================================
        subgraph Ingestion [Autonomous Ingestion Pipeline]
        direction TB
        Incoming["üìÇ /data/incoming/"]

        subgraph WatcherLogic [Watcher Service]
        Detect["üëÄ Detect Event<br />(Watchdog)"]
        Debounce{"‚è≥ File Stable?<br />(Wait 1s)"}
        end

        FileProcessor["‚öôÔ∏è File Processor<br />(Orchestrator)"]

        subgraph Utils [Support Services]
        TextUtils["üõ†Ô∏è TextUtils<br />(Cleaning/Normalization)"]
        Celery["üêá Celery Worker<br />(Async Task Queue)"]
        end

        subgraph Extraction [Content Extraction Strategy]
        ExtPDF["üìÑ PDF Extractor<br />(pypdf + fallback)"]
        ExtOCR["üì∑ OCR Engine<br />(Tesseract v5)"]
        ExtAudio["üé§ Audio Transcriber<br />(FFmpeg + SpeechRec)"]
        end

        Router{"üß† Hybrid Classifier<br />(Regex + Llama)"}
        Chunker["üî™ Text Chunker<br />(1000 chars / 200 overlap)"]
        end

        %% ==========================================
        %% 3. STORAGE LAYER
        %% ==========================================
        subgraph Storage [Persistence Layer]
        Chroma[("üóÑÔ∏è ChromaDB<br />Vector Store")]
        MetaDB[("üìù SQLite/Redis<br />Metadata & Cache")]
        SortedFS["üìÇ /data/sorted/<br />(Organized Storage)"]
        end

        %% ==========================================
        %% 4. RETRIEVAL & INFERENCE ( READ PATH )
        %% ==========================================
        subgraph RAG [Reasoning Engine]
        EmbedModel["üî£ Embedding Model<br />(all-MiniLM-L6-v2)"]
        VectorSearch["üîç ANN Search<br />(Cosine Similarity)"]

        filter{"‚öñÔ∏è Cross-Encoder<br />(Re-Ranker)"}

        ContextWin["üìë Context Window<br />(Prompt Engineering)"]
        LLM["ü§ñ Llama 3.2<br />(3B Quantized)"]
        end

        %% ==========================================
        %% 5. EXTERNAL INFRASTRUCTURE
        %% ==========================================
        subgraph External [External Infrastructure]
        OllamaAPI(("ü¶ô Ollama API<br />(Localhost:11434)"))
        end

        %% ==========================================
        %% CONNECTIONS & DATA FLOW
        %% ==========================================

        %% Flow 1: File Upload
        User -- "1. Uploads File (PDF/Docs)" --> Browser
        Browser -- "2. Save to Disk" --> Incoming
        Incoming -.-> Detect
        Detect --> Debounce
        Debounce -- "Stable" --> FileProcessor
        Debounce -- "Writing..." --> Debounce

        %% Flow 2: Processing
        FileProcessor -- "Determines Type" --> Extraction
        FileProcessor -- "Cleaning" --> TextUtils
        FileProcessor -- "Async Job" --> Celery
        Celery -- "Process" --> Extraction

        ExtPDF -- "Needs text" --> FileProcessor
        ExtOCR -- "Scanned Image" --> FileProcessor
        FileProcessor -- "Raw Text" --> Router

        Router -- "Category: Finance" --> LLM
        LLM -.->|"Zero-Shot Label"| Router
        Router -- "Category: Finance" --> Chunker

        Chunker -- "Text Chunks" --> EmbedModel
        EmbedModel -- "Vectors (384d)" --> Chroma
        FileProcessor -- "Move File" --> SortedFS
        FileProcessor -- "Index Meta" --> MetaDB

        Celery -.-> MetaDB

        %% Flow 3: User Query
        User -- "3. Asks Question" --> Browser
        Browser -- "POST /chat" --> API
        API -- "Query Text" --> EmbedModel
        EmbedModel -- "Query Vector" --> VectorSearch
        VectorSearch -- "Top 5 Chunks" --> Chroma
        Chroma -- "Raw Documents" --> filter

        filter -- "Score < 0.35" --> X((üóëÔ∏è Discard))
            filter -- "Score > 0.35" --> ContextWin

            ContextWin -- "System Prompt +<br />Filtered Context" --> LLM
            LLM -- "Final Response" --> API
            API -- "JSON Stream" --> Browser
            Browser -- "Display Answer" --> User

            %% External Links
            LLM -.-> OllamaAPI

            %% ==========================================
            %% STYLING APPLICATION
            %% ==========================================
            class User,Browser,API blue
            class Incoming,Detect,Debounce,FileProcessor,Router,Chunker green
            class ExtPDF,ExtOCR,ExtAudio grey
            class Chroma,MetaDB,SortedFS orange
            class EmbedModel,VectorSearch,filter,ContextWin,LLM purple
            class TextUtils,Celery yellow
            class X red
    </div>

    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
</body>

</html>